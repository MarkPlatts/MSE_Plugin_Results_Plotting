{
    "collab_server" : "",
    "contents" : "#==========================================================\n#Plot the end distribution for the last 5 year mean biomass\n#==========================================================\n\nisNotGroupToPlot = function(biomass.file.name){\n  startloc = str_locate(biomass.file.name, \"GroupNo\")[1]\n  endloc = str_locate(biomass.file.name, \".csv\")[1] - 1\n  group.groupnoxx.format = str_sub(biomass.file.name, startloc, endloc)\n  if(!group.groupnoxx.format %in% params$Groups2Plot) return (TRUE)\n  #else\n  return(FALSE)\n  \n}\n\nif(TRUE){\n  \n  # INITIALISATION START ===============================================================================================\n  \n  #start with a clean sheet\n  rm(list = ls())\n  \n  #load libraries\n  library(ggplot2)\n  library(stringr)\n  \n  #load sources\n  source.folder.location = dirname(sys.frame(1)$ofile)\n  setwd(source.folder.location)\n  source(\"share_tools.R\")\n  source(\"initialisation.R\")\n  \n  params = initialise_params()\n  output_folder = paste(params$plot.path,\"OUTPUT_END_DISTRIBUTIONS/\", sep=\"\")\n  #root results path\n  # root.plot =     \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/North Sea MultiAnnual Plan/ResultsType1-4_220117/Plots/\"\n  # RootPath =  \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/North Sea MultiAnnual Plan/ResultsType1-4_220117/Results/\"\n  \n  # hcr.folders = c(\"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/NorthSea Model/2015 FINAL Key Run/DATA/HCRs/Type1_BmsytoZero\",\n  #                 \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/NorthSea Model/2015 FINAL Key Run/DATA/HCRs/Type2_BmsyBlimClifftoZero\",\n  #                 \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/NorthSea Model/2015 FINAL Key Run/DATA/HCRs/Type3_BmsytoZeroatBlim\",\n  #                 \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/NorthSea Model/2015 FINAL Key Run/DATA/HCRs/Type4_BmsyBlimClifftoFmin\")\n  \n  # INITIALISATION END ===============================================================================================\n  \n  \n  #RootPath =  \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/North Sea MultiAnnual Plan/ResultsType1-4_220117/Results/\"\n  \n  #get a list of all the groups\n  unique.groups = LoadUniqueGroups(params$RootPath)\n  \n  # #get a list of strategy.tables with strategy name\n  # strategies.table = getStrategyTable(hcr.folders)\n  \n  # #remove all conservation hcrs from strategy table\n  # strategies.table = filter(strategies.table, Target_or_Conservation==0)\n  \n  #Create a data.table in which to compile all the tables from each file ready for saving to csv\n  dt.all = data.table()\n  \n  for(igroup in unique.groups)\n  {\n \n    #get the file in HCRQuota_Targ folder that are for \"AllFleets\"\n    biomass.file.name = GetFileName_ContainsStrings(FolderPath = paste(params$RootPath, \"Biomass/\", sep=\"\"), \n                                                 Strings = c(igroup), WithPath=T)\n    \n    #check whether group is listed to be plotted\n    if(isNotGroupToPlot(biomass.file.name)) next\n    \n    #load the files and sum\n    biomass = calcLast5Year(biomass.file.name, \"biomass.last5yearsum\", 4, function.type = 2)\n    \n    #Modify the values so that they are for the entire region\n    biomass$biomass.last5yearsum = biomass$biomass.last5yearsum*params$Area/1000\n    \n    #add the group name to a column because I'm going to facet plot using this\n    biomass = appendVariableToDataTable(dt = biomass, variable = igroup, variablename = \"GroupName\", beg=TRUE, end=FALSE)\n    \n    #bind them together ready for plotting\n    dt.all = rbind(dt.all, biomass)\n    \n    max.axis.x = max(biomass$biomass.last5yearsum)\n    number_bins = 30\n    \n    #filter for the strategies selected in initialisation.R\n    biomass = biomass[biomass$StrategyName %in% params$strats, ]\n    \n    #plot them  \n    B_SPECIES = ggplot(biomass,aes(x=biomass.last5yearsum))\n    B_SPECIES = B_SPECIES + geom_histogram(binwidth = (max.axis.x)/number_bins, aes(y=..density..), colour=\"darkgreen\", fill=\"darkgreen\")\n    B_SPECIES = B_SPECIES + facet_wrap(~StrategyName, ncol=1)\n    \n    ggsave(B_SPECIES, file=paste(output_folder, \"Biomass5YearMean_\",igroup,\".png\", sep=\"\"), width=6, height=length(params$strats)*1.5, limitsize = FALSE)\n\n  }\n  \n\n  # B_SPECIES = B_SPECIES + ylab(\"Density\") + xlab(plotdata$xaxis.label[result.index]) #xlab(\"Minimum Biomass (1000 t)\")\n  # B_SPECIES = B_SPECIES + labs(title=paste(plotdata$species_in_resultsfile[species.index[1]], \"\\n\", plotdata$result.names[result.index], sep=\"\"))\n  # B_SPECIES = B_SPECIES + theme(strip.text = element_text(size=6), panel.background = element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(),axis.line=element_line(colour=\"Black\"), axis.text=element_text(colour=\"Black\", size=6))\n  # if(plotdata$result.names[result.index] ==\"BiomassEnd\" || plotdata$result.names[result.index]==\"BiomassMin\"){\n  #   B_SPECIES = B_SPECIES + geom_text(data = plotdata$blim.species3.lab, aes(x = x, y = y, label = lab), size = 2)\n  #   B_SPECIES = B_SPECIES + geom_text(data = plotdata$bpa.species3.lab, aes(x = x, y = y, label = lab), size = 2)\n  #   B_SPECIES = B_SPECIES + geom_vline(data=plotdata$blim.bpa.xaxis, aes(xintercept=blim.axis),linetype=\"dotdash\", size=0.15)\n  #   B_SPECIES = B_SPECIES + geom_vline(data=plotdata$blim.bpa.xaxis, aes(xintercept=bpa.axis),linetype=\"longdash\", size=0.15)\n  #   B_SPECIES = B_SPECIES + geom_text(data = plotdata$bpa.species5.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)\n  #   B_SPECIES = B_SPECIES + geom_text(data = plotdata$blim.species5.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)\n  # }\n  # B_SPECIES = B_SPECIES + coord_cartesian(ylim = c(0, as.numeric(plotdata$max.axis$y)*1.1), xlim = c(0, as.numeric(plotdata$max.axis$x)))\n  # # median, Blim and Bpa lines and labels\n  # B_SPECIES = B_SPECIES + geom_vline(data=plotdata$ResultMedian.species, aes(xintercept=median.species),linetype=\"dotted\", size=0.15)\n  # B_SPECIES = B_SPECIES + geom_text(data = plotdata$b.species4.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)\n  # if(plotdata$result.names[result.index]==\"DiscardMortalities\" || plotdata$result.names[result.index]==\"DiscardSurvivals\" || plotdata$result.names[result.index]==\"Landings\"){\n  #   geom_text(data = plotdata$c.species4.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)+\n  #     geom_text(data = plotdata$c.species5.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)+\n  #     geom_text(data = plotdata$c.species6.lab, aes(x = x, y = y, label = lab), size = 2, angle=90, vjust=-0.5)\n  # }\n  \n\n  \n}\n  \n\n\n\n  \n\n  \nif(FALSE){\n  \n\n  \n  #Load up biomass reference file\n  biom_refs = read.csv(paste(params$plot.path,\"/Biom_refs.csv\",sep=''))\n  \n  #initialise plotting params\n  plotting_params = initialise_plotting_params(\"Biomass\", params$plot_each_timestep, params$StartRun_Year, params$EndRun_Year, params$RootPath)\n  \n  for(G in plotting_params$g){\n    \n    #Get the filename to be used to check whether yearly in name, to name files of plots and to add text to plots\n    FILENAME = substr(G,1,nchar(G)-4)\n    \n    #Only use year files\n    if(IsIncorrectFileType_YearlyMonthly(FILENAME, plot_yearly == T)) next\n    \n    #Setup the connection for saving plots to file\n    png(filename = paste(params$plot.path,\"/OUTPUT_END_DISTRIBUTIONS/\",FILENAME,\"_5YrMean.png\",sep=\"\"), res=900, width=8, height=4, units='in')\n    \n    #Load the data from file\n    plotting_params$dat <- read.csv(paste(params$RootPath,\"/Biomass/\",G, sep=''),skip=7, head=T)\n    \n    #Modify the values so that they are for the entire region\n    plotting_params$dat[,-c(1:4)] <- plotting_params$dat[,-c(1:4)]*params$Area/1000 #Multiplying it by area gives absolute biomass across area\n                                                                                    #Dividing by 1000 gives value in kt - we do this to prevent scientific units\n    \n    Biomass.file = GetFileName_ContainsStrings(FolderPath = paste(params$RootPath, \"/Biomass/\", sep=\"\"), \n                                                 Strings = c(igroup), WithPath=T)\n    \n    #Extract reference points\n    GroupName = plotting_params$dat[1,1]\n    bpa = read_biom_refs(biom_refs, GroupName, \"bpa\")     #Needs to be specified in the file as kt\n    blim = read_biom_refs(biom_refs, GroupName, \"blim\")   #Needs to be specified in the file as kt\n    \n    #load the files and sum\n    realised.f = calcLast5Year(realisedF.file, \"realised.f.last5yearsum\", 5, function.type = 2)\n    \n  }\n  \n  #Load the biomass data time series\n  \n  \n  #Calculate the last 5 year means for each model,group strategy combination\n  \n  \n  #Get into a format with which to plot\n  \n  \n  #Gather or calc any other values required to plot\n  \n  \n  #Plot the distributions\n  \n  \n\n}\n\n\n",
    "created" : 1487949278239.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3053794831",
    "id" : "1F76F0CA",
    "lastKnownWriteTime" : 1488229332,
    "last_content_update" : 1488229332373,
    "path" : "C:/Users/Mark/Desktop/MSE_Plugin_Results_Plotting/Plot_Distribution_Last5YearsBiomassMean.R",
    "project_path" : "Plot_Distribution_Last5YearsBiomassMean.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}