{
    "collab_server" : "",
    "contents" : "#==========================================================\n#Plot the end distribution for the last 5 year mean biomass\n#==========================================================\n\n\nif(TRUE){\n  \n  # INITIALISATION START ===============================================================================================\n  \n  #start with a clean sheet\n  rm(list = ls())\n  \n  #load libraries\n  library(ggplot2)\n  library(stringr)\n  \n  #load sources\n  source.folder.location = dirname(sys.frame(1)$ofile)\n  setwd(source.folder.location)\n  source(\"share_tools.R\")\n  source(\"plot_tools.R\")\n  source(\"initialisation.R\")\n  \n  params = initialise_params()\n  output_folder = paste(params$plot.path,\"OUTPUT_END_DISTRIBUTIONS/\", sep=\"\")\n  biomrefs_csv_inc_path = paste(params$plot.path,\"Biom_refs.csv\", sep=\"\")\n\n  # INITIALISATION END ===============================================================================================\n  \n  \n  # FUNCTIONS START  ===============================================================================================\n  \n  isNotGroupToPlot = function(biomass.file.name){\n    startloc = str_locate(biomass.file.name, \"GroupNo\")[1]\n    endloc = str_locate(biomass.file.name, \".csv\")[1] - 1\n    group.groupnoxx.format = str_sub(biomass.file.name, startloc, endloc)\n    if(!group.groupnoxx.format %in% params$Groups2Plot) return (TRUE)\n    #else\n    return(FALSE)\n    \n  }\n  \n  # FUNCTIONS END  ===============================================================================================\n  \n  \n  #RootPath =  \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/North Sea MultiAnnual Plan/ResultsType1-4_220117/Results/\"\n  \n  #get a list of all the groups\n  unique.groups = LoadUniqueGroups(params$RootPath)\n  \n  # Loading reference points Blim and Bpa\n  biom_refs<-read.csv(biomrefs_csv_inc_path,sep=\",\", header=TRUE)\n  \n  summary.dt = data.table()\n  \n  \n  #Configure the tables and variables for calculating percent <Blim & Bpa\n  SumBlim=list()  #The number of results that are above the Blim\n  percBlim=list() #The percentage of the results above Blim\n  SumBpa=list()   #The number of results that are above Bpa\n  percBpa=list()  #The percentage of the results above Bpa\n  df.perc.Blim = data.table()\n  df.perc.Bpa = data.table()\n  nUniqueStrategies = unique(params$strats)\n  \n  for(igroup in unique.groups){\n \n    #get the file in HCRQuota_Targ folder that are for \"AllFleets\"\n    biomass.file.name = GetFileName_ContainsStrings(FolderPath = paste(params$RootPath, \"Biomass/\", sep=\"\"), \n                                                 Strings = c(igroup), WithPath=T)\n    \n    #check whether group is listed to be plotted\n    if(isNotGroupToPlot(biomass.file.name)) next\n    \n    #Load the file\n    biomass = fread(biomass.file.name, skip=7, header=T)\n    \n    #load the files and sum\n    biomass = calcLast5Year(biomass, \"biomass.last5yearmean\", 4, function.type = 2)\n    \n    #filter for the strategies selected in initialisation.R\n    biomass = biomass[biomass$StrategyName %in% params$strats, ]\n    \n    #Modify the values so that they are for the entire region\n    biomass$biomass.last5yearmean = biomass$biomass.last5yearmean*params$Area/1000\n    \n    #add the group name to a column because I'm going to facet plot using this\n    biomass = appendVariableToDataTable(dt = biomass, variable = igroup, variablename = \"GroupName\", beg=TRUE, end=FALSE)\n    \n    max.axis.x = max(biomass$biomass.last5yearmean)\n    \n    #Calc the percent below Bpa & Blim\n    bpa = biom_refs[biom_refs$Group==igroup,]$Bpa\n    blim = biom_refs[biom_refs$Group==igroup,]$Blim\n    \n    biomass$below.bpa = biomass$biomass.last5yearmean<bpa\n    biomass$above.bpa = biomass$biomass.last5yearmean>=bpa\n    biomass$below.blim = biomass$biomass.last5yearmean<blim\n    biomass$above.blim = biomass$biomass.last5yearmean>=blim\n    \n    biomass.percent.below.refpoints = biomass[,list(bpa = sum(below.bpa)/length(below.bpa), \n                                                    blim = sum(below.blim)/length(below.blim)), by=\"StrategyName\"]\n    \n    #calculate the 5 number summary for each strategy\n    biomass.summary.by.strategy = biomass[,list(Min = min(biomass.last5yearmean), \n                  LQ = quantile(biomass.last5yearmean, .25, na.rm=TRUE), \n                  Median = median(biomass.last5yearmean),\n                  UQ = quantile(biomass.last5yearmean, .75, na.rm=TRUE),\n                  Max = max(biomass.last5yearmean),\n                  Mean = mean(biomass.last5yearmean),\n                  Percent.Below.Bpa = sum(below.bpa)/length(above.bpa),\n                  Percent.Below.Blim = sum(below.blim)/length(below.blim)), by=\"StrategyName\"]\n    biomass.summary.by.strategy = appendVariableToDataTable(biomass.summary.by.strategy, igroup, \"GroupName\", beg=TRUE, end=FALSE)\n    \n    summary.dt = rbind(summary.dt, biomass.summary.by.strategy)\n\n    #get 10th of plot width to add this to where the vertical lines are\n    distance.from.vlines = max.axis.x/100\n    \n    #for each group with a blim or bpa create a table with all the labels in it for plotting vertical lines\n    #I believe we need to have a unique row for each strategy because that is how ggplot knows how to plot for each strategy plot with facet\n    #Extract reference points\n    if(igroup %in% biom_refs[,\"Group\"]){\n\n      nStrategies = length(params$strats)\n      bpa = read_biom_refs(biom_refs, igroup, \"bpa\")     #Needs to be specified in the file as kt\n      blim = read_biom_refs(biom_refs, igroup, \"blim\")   #Needs to be specified in the file as kt\n      max.axis.x = max(max.axis.x, bpa, blim)\n\n      ref.points = data.table(StrategyName = params$strats, \n                              bpa = rep(bpa, nStrategies), bpa_lab = rep(\"Bpa\", nStrategies), bpa_lab_pos = rep(bpa - distance.from.vlines, nStrategies), \n                              blim = rep(blim, nStrategies), blim_lab = rep(\"Blim\", nStrategies), blim_lab_pos = rep(blim - distance.from.vlines, nStrategies),\n                              bmedian = biomass.summary.by.strategy$Median, bmedian_lab = rep(\"Median\", nStrategies), bmedian_lab_pos = biomass.summary.by.strategy$Median - distance.from.vlines)\n      \n    }\n    \n\n    number_bins = 40\n    \n    #plot them  \n    B_SPECIES = ggplot(biomass,aes(x=biomass.last5yearmean))\n    B_SPECIES = B_SPECIES + geom_histogram(binwidth = (max.axis.x)/number_bins, aes(y=..density..), colour=\"darkgreen\", fill=\"lightgreen\")\n    B_SPECIES = B_SPECIES + facet_wrap(~StrategyName, ncol=1)\n\n    #if the group has a blim and bpa then extract from table and plot\n    #species_in_biomrefsfile<-levels(blim.bpa[,\"Group\"])\n\n    if(igroup %in% biom_refs[,\"Group\"]){\n      max.y = max(ggplot_build(B_SPECIES)$data[[1]]$density)\n      B_SPECIES = B_SPECIES + geom_text(data = ref.points, aes(x = blim_lab_pos, y = max.y*9/10, label = blim_lab), size = 2, angle = 90)\n      B_SPECIES = B_SPECIES + geom_text(data = ref.points, aes(x = bpa_lab_pos, y = max.y*9/10, label = bpa_lab), size = 2, angle=90)\n      B_SPECIES = B_SPECIES + geom_text(data = ref.points, aes(x = bmedian_lab_pos, y = max.y*9/10, label = bmedian_lab), size = 2, angle=90)\n      B_SPECIES = B_SPECIES + geom_vline(data =ref.points, aes(xintercept=blim),linetype=\"dotdash\", size=0.15)\n      B_SPECIES = B_SPECIES + geom_vline(data =ref.points, aes(xintercept=bpa),linetype=\"longdash\", size=0.15)\n      B_SPECIES = B_SPECIES + geom_vline(data =ref.points, aes(xintercept=bmedian),linetype=\"longdash\", size=0.15)\n    }\n    \n    ggsave(B_SPECIES, file=paste(output_folder, \"Biomass5YearMean_\",igroup,\".png\", sep=\"\"), width=6, height=length(params$strats)*1.5, limitsize = FALSE)\n\n  }\n  \n  write.csv(summary.dt, file = \"C:/Users/Mark/Dropbox/GAP2_MSE Plugin2/North Sea MultiAnnual Plan/ResultsType1-4_220117/Plots/Tables/biomass_5NoSummary.csv\")\n  \n  \n}\n\n\n",
    "created" : 1487949278239.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4161234108",
    "id" : "1F76F0CA",
    "lastKnownWriteTime" : 1488794843,
    "last_content_update" : 1488794843898,
    "path" : "C:/Users/Mark/Desktop/MSE_Plugin_Results_Plotting/Plot_Distribution_Last5YearsBiomassMean.R",
    "project_path" : "Plot_Distribution_Last5YearsBiomassMean.R",
    "properties" : {
        "source_window_id" : "",
        "tempName" : "Untitled1"
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}